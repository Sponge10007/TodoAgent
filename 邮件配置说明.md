# 📧 邮件提醒功能配置说明

## 功能介绍

生活管家AI现已支持邮件提醒功能，可以在以下情况自动发送邮件：

- 🔔 **任务提醒**：任务开始前15分钟发送提醒邮件
- 🌅 **每日开始提醒**：每天早上8点发送今日计划概览
- 🌙 **每日总结提醒**：每天晚上9点发送完成情况总结

## 环境配置

### 1. 基本配置

在 `.env` 文件中添加以下邮件服务配置：

```env
# 邮件服务配置
EMAIL_SMTP_SERVER=smtp.gmail.com
EMAIL_SMTP_PORT=587
EMAIL_USERNAME=your_email@gmail.com
EMAIL_PASSWORD=your_app_password
EMAIL_FROM_NAME=生活管家AI
```

### 2. 常用邮箱配置

#### Gmail 配置
```env
EMAIL_SMTP_SERVER=smtp.gmail.com
EMAIL_SMTP_PORT=587
EMAIL_USERNAME=your_email@gmail.com
EMAIL_PASSWORD=your_app_password  # 需要使用应用专用密码
```

**Gmail 应用密码设置步骤：**
1. 登录 Google 账户
2. 进入 "安全性" 设置
3. 启用 "两步验证"
4. 生成 "应用专用密码"
5. 使用生成的16位密码作为 `EMAIL_PASSWORD`

#### QQ邮箱配置
```env
EMAIL_SMTP_SERVER=smtp.qq.com
EMAIL_SMTP_PORT=587
EMAIL_USERNAME=your_qq@qq.com
EMAIL_PASSWORD=your_authorization_code  # QQ邮箱授权码
```

**QQ邮箱授权码设置步骤：**
1. 登录QQ邮箱
2. 进入 "设置" → "账户"
3. 开启 "POP3/IMAP/SMTP/Exchange/CardDAV/CalDAV服务"
4. 生成授权码
5. 使用授权码作为 `EMAIL_PASSWORD`

#### 163邮箱配置
```env
EMAIL_SMTP_SERVER=smtp.163.com
EMAIL_SMTP_PORT=587
EMAIL_USERNAME=your_email@163.com
EMAIL_PASSWORD=your_authorization_code  # 163邮箱授权码
```

#### Outlook/Hotmail配置
```env
EMAIL_SMTP_SERVER=smtp-mail.outlook.com
EMAIL_SMTP_PORT=587
EMAIL_USERNAME=your_email@outlook.com
EMAIL_PASSWORD=your_password
```

### 3. 企业邮箱配置

如果使用企业邮箱，请联系您的IT管理员获取SMTP服务器信息：

```env
EMAIL_SMTP_SERVER=mail.yourcompany.com
EMAIL_SMTP_PORT=587  # 或 25, 465
EMAIL_USERNAME=your_email@yourcompany.com
EMAIL_PASSWORD=your_password
```

## 使用步骤

### 1. 安装依赖

确保已安装邮件服务依赖：

```bash
pip install jinja2 aiosmtplib
```

或者重新安装所有依赖：

```bash
pip install -r requirements.txt
```

### 2. 配置环境变量

1. 复制 `env.example` 为 `.env`
2. 在 `.env` 文件中配置邮件服务信息
3. 重启应用服务

### 3. 测试邮件服务

1. 启动应用后，打开 http://localhost:8000
2. 创建一个计划
3. 点击 "设置提醒" 按钮
4. 勾选 "邮件提醒"
5. 输入您的邮箱地址
6. 点击 "发送测试邮件" 按钮
7. 检查邮箱是否收到测试邮件

### 4. 设置计划提醒

1. 在计划卡片中点击 "设置提醒"
2. 勾选 "邮件提醒"
3. 输入接收提醒的邮箱地址
4. 设置每日开始和总结提醒时间
5. 点击 "设置提醒" 完成配置

## API接口

### 测试邮件服务
```http
POST /api/email/test?to_email=test@example.com
```

### 发送邮件提醒
```http
POST /api/email/send-reminder
```

参数：
- `to_email`: 收件人邮箱
- `reminder_type`: 提醒类型 (task_reminder, daily_start, daily_summary)
- `task_title`: 任务标题
- `task_time`: 任务时间
- `duration`: 任务时长
- `plan_title`: 计划标题
- `goal`: 目标描述
- `total_tasks`: 总任务数
- `completed_tasks`: 已完成任务数

## 故障排除

### 常见问题

1. **邮件发送失败**
   - 检查SMTP服务器地址和端口
   - 确认用户名和密码正确
   - 检查网络连接

2. **Gmail发送失败**
   - 确保已启用两步验证
   - 使用应用专用密码，不是账户密码
   - 检查是否开启了"不够安全的应用的访问权限"

3. **QQ/163邮箱发送失败**
   - 确保已开启SMTP服务
   - 使用授权码，不是登录密码
   - 检查邮箱设置中的第三方客户端权限

4. **收不到邮件**
   - 检查垃圾邮件箱
   - 确认邮箱地址拼写正确
   - 检查邮箱的过滤规则

### 调试方法

1. **查看应用日志**
   ```bash
   tail -f logs/app.log
   ```

2. **测试SMTP连接**
   使用API测试邮件服务：
   ```bash
   curl -X POST "http://localhost:8000/api/email/test?to_email=your_email@example.com"
   ```

3. **检查环境变量**
   确保 `.env` 文件中的配置正确加载

## 安全建议

1. **使用应用专用密码**
   - 不要使用主账户密码
   - 定期更换应用密码

2. **保护配置文件**
   - 不要将 `.env` 文件提交到版本控制
   - 设置适当的文件权限

3. **网络安全**
   - 使用TLS加密连接
   - 在生产环境中配置防火墙

## 高级配置

### 自定义邮件模板

邮件模板位于 `email_service.py` 中，您可以根据需要修改HTML模板：

- `send_task_reminder()`: 任务提醒模板
- `send_daily_start_reminder()`: 每日开始模板  
- `send_daily_summary()`: 每日总结模板

### 异步发送

邮件服务支持异步发送，提高应用性能：

```python
await email_service.send_email_async(
    to_email="user@example.com",
    subject="测试邮件",
    content="邮件内容"
)
```

### 批量发送

可以扩展服务支持批量发送邮件：

```python
# 在 email_service.py 中添加批量发送方法
def send_bulk_emails(self, recipients: List[str], subject: str, content: str):
    # 批量发送实现
    pass
```

## 支持

如果您在配置过程中遇到问题，请：

1. 查看应用日志获取详细错误信息
2. 检查网络连接和防火墙设置
3. 确认邮箱服务商的SMTP设置
4. 联系技术支持获取帮助

---

**注意**：首次使用邮件功能时，建议先发送测试邮件确保配置正确，然后再设置正式的提醒功能。 